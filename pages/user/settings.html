<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramètres | PayFusion Haiti</title>
    
    <!-- Polices & Icônes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            /* Mode Clair */
            --primary: #0056b3;
            --primary-glow: rgba(0, 86, 179, 0.1);
            --secondary: #002d5e;
            --bg: #f8fafc;
            --white: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode {
            /* Mode Sombre */
            --bg: #0f172a;
            --white: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --primary-glow: rgba(0, 185, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); transition: var(--transition); min-height: 100vh; overflow-x: hidden; }

        /* Arrière-plan Dynamique */
        .bg-blobs {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; filter: blur(80px); opacity: 0.5;
        }
        .blob {
            position: absolute; width: 400px; height: 400px;
            background: var(--primary-glow); border-radius: 50%;
            animation: move 15s infinite alternate;
        }
        @keyframes move { from { transform: translate(-10%, -10%); } to { transform: translate(15%, 15%); } }

        header {
            height: 70px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px);
            display: flex; align-items: center; padding: 0 6%; position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border); transition: var(--transition);
        }
        header .back-btn { color: var(--primary); font-size: 1.4rem; text-decoration: none; margin-right: 15px; }
        header h1 { font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px; }

        .container { padding: 25px 6%; max-width: 650px; margin: 0 auto; }

        .settings-section { margin-bottom: 35px; }
        .section-title { 
            font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1.5px; 
            color: var(--primary); font-weight: 800; margin-bottom: 15px; margin-left: 5px;
        }

        .settings-card {
            background: var(--white); border-radius: 26px; box-shadow: 0 10px 30px rgba(0,0,0,0.02); 
            border: 1px solid var(--border); overflow: hidden; transition: var(--transition);
        }

        .setting-item {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); transition: 0.2s;
        }
        .setting-item:last-child { border-bottom: none; }

        .item-info { display: flex; align-items: center; gap: 18px; }
        .item-icon { 
            width: 44px; height: 44px; background: var(--primary-glow); color: var(--primary); 
            border-radius: 14px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; 
        }
        
        .item-label { display: flex; flex-direction: column; gap: 2px; }
        .item-label b { font-size: 0.95rem; font-weight: 700; color: var(--text-main); }
        .item-label span { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }

        /* SWITCH TOGGLE FINTECH */
        .switch { position: relative; display: inline-block; width: 48px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* SELECT CUSTOM */
        select {
            background: var(--bg); color: var(--text-main); border: 1.5px solid var(--border);
            padding: 10px 15px; border-radius: 12px; font-size: 0.9rem; outline: none; 
            cursor: pointer; font-weight: 600; transition: var(--transition);
        }
        select:focus { border-color: var(--primary); }

        .btn-logout {
            margin-top: 20px; width: 100%; padding: 18px; background: rgba(239, 68, 68, 0.1); 
            color: var(--danger); border: none; border-radius: 20px; font-weight: 800; cursor: pointer;
            transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px;
            font-size: 1rem;
        }
        .btn-logout:hover { background: var(--danger); color: white; transform: translateY(-2px); }

        @media (max-width: 480px) {
            .container { padding: 20px 5%; }
            .settings-card { border-radius: 22px; }
            .item-info { gap: 12px; }
        }
    </style>
</head>
<body id="main-body">

    <div class="bg-blobs">
        <div class="blob"></div>
    </div>

    <header>
        <a href="../home.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i></a>
        <h1 id="lang-title">Paramètres</h1>
    </header>

    <div class="container">
        <!-- APPARENCE -->
        <div class="settings-section">
            <h3 class="section-title" id="lang-sec-appearance">Apparence</h3>
            <div class="settings-card">
                <div class="setting-item">
                    <div class="item-info">
                        <div class="item-icon"><i class="fa-solid fa-moon"></i></div>
                        <div class="item-label">
                            <b id="lang-darkmode">Mode Sombre</b>
                            <span id="lang-darkmode-sub">Réduire la fatigue oculaire</span>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- PRÉFÉRENCES -->
        <div class="settings-section">
            <h3 class="section-title" id="lang-sec-prefs">Préférences</h3>
            <div class="settings-card">
                <!-- LANGUE -->
                <div class="setting-item">
                    <div class="item-info">
                        <div class="item-icon"><i class="fa-solid fa-globe"></i></div>
                        <div class="item-label">
                            <b id="lang-language">Langue</b>
                            <span id="lang-language-sub">Français / English / Kreyòl</span>
                        </div>
                    </div>
                    <select id="language-select">
                        <option value="fr">Français</option>
                        <option value="en">English</option>
                        <option value="kr">Kreyòl</option>
                    </select>
                </div>

                <!-- NOTIFICATIONS -->
                <div class="setting-item">
                    <div class="item-info">
                        <div class="item-icon"><i class="fa-solid fa-bell-ring"></i></div>
                        <div class="item-label">
                            <b id="lang-notif">Notifications Push</b>
                            <span id="lang-notif-sub">Alertes de validation de commande</span>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="notif-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- SÉCURITÉ -->
        <div class="settings-section">
            <h3 class="section-title" id="lang-sec-security">Sécurité & Compte</h3>
            <div class="settings-card">
                <div class="setting-item" onclick="resetPassword()" style="cursor:pointer;">
                    <div class="item-info">
                        <div class="item-icon"><i class="fa-solid fa-shield-keyhole"></i></div>
                        <div class="item-label">
                            <b id="lang-pass">Authentification</b>
                            <span id="lang-pass-sub">Réinitialiser le mot de passe</span>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="font-size: 0.8rem; color: var(--text-muted);"></i>
                </div>
            </div>
        </div>

        <button class="btn-logout" onclick="logout()">
            <i class="fa-solid fa-power-off"></i> <span id="lang-logout">Déconnecter la session</span>
        </button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA0Aqy9keUMZb_FSqW7qdg0RYxlpO5gGmw",
            authDomain: "pay-fusion-509.firebaseapp.com",
            projectId: "pay-fusion-509",
            storageBucket: "pay-fusion-509.firebasestorage.app",
            messagingSenderId: "401434428368",
            appId: "1:401434428368:web:c1f526254f63fa57402fd5",
            measurementId: "G-JN41S8MKWH"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 1. GESTION DU THÈME
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.getElementById('main-body');

        themeToggle.addEventListener('change', () => {
            if(themeToggle.checked) {
                body.classList.add('dark-mode');
                localStorage.setItem('payfusion-theme', 'dark');
            } else {
                body.classList.remove('dark-mode');
                localStorage.setItem('payfusion-theme', 'light');
            }
        });

        // 2. DICTIONNAIRE DE TRADUCTION
        const translations = {
            fr: {
                title: "Paramètres", sec_app: "Apparence", dark: "Mode Sombre", dark_sub: "Réduire la fatigue oculaire",
                sec_pref: "Préférences", lang: "Langue", lang_sub: "Choisir votre langue", notif: "Notifications Push",
                notif_sub: "Alertes de validation de commande", sec_secu: "Sécurité & Compte", pass: "Authentification", 
                pass_sub: "Réinitialiser le mot de passe", logout: "Déconnecter la session"
            },
            en: {
                title: "Settings", sec_app: "Appearance", dark: "Dark Mode", dark_sub: "Reduce eye strain",
                sec_pref: "Preferences", lang: "Language", lang_sub: "Choose your language", notif: "Push Notifications",
                notif_sub: "Order validation alerts", sec_secu: "Security & Account", pass: "Authentication", 
                pass_sub: "Reset your password", logout: "Sign out session"
            },
            kr: {
                title: "Paramèt", sec_app: "Aparans", dark: "Mòd Nwa", dark_sub: "Pou je ou pa fatige",
                sec_pref: "Preferans", lang: "Lang", lang_sub: "Chwazi lang pa ou", notif: "Notifikasyon",
                notif_sub: "Avètisman kòmand ou", sec_secu: "Sekirite ak Kont", pass: "Otantifikasyon", 
                pass_sub: "Chanje modpas ou", logout: "Dekonekte sesyon an"
            }
        };

        const langSelect = document.getElementById('language-select');
        langSelect.addEventListener('change', (e) => {
            const selectedLang = e.target.value;
            applyLanguage(selectedLang);
            saveLanguageToFirestore(selectedLang);
        });

        function applyLanguage(lang) {
            const t = translations[lang] || translations.fr;
            document.getElementById('lang-title').textContent = t.title;
            document.getElementById('lang-sec-appearance').textContent = t.sec_app;
            document.getElementById('lang-darkmode').textContent = t.dark;
            document.getElementById('lang-darkmode-sub').textContent = t.dark_sub;
            document.getElementById('lang-sec-prefs').textContent = t.sec_pref;
            document.getElementById('lang-language').textContent = t.lang;
            document.getElementById('lang-language-sub').textContent = t.lang_sub;
            document.getElementById('lang-notif').textContent = t.notif;
            document.getElementById('lang-notif-sub').textContent = t.notif_sub;
            document.getElementById('lang-sec-security').textContent = t.sec_secu;
            document.getElementById('lang-pass').textContent = t.pass;
            document.getElementById('lang-pass-sub').textContent = t.pass_sub;
            document.getElementById('lang-logout').textContent = t.logout;
            localStorage.setItem('payfusion-lang', lang);
        }

        // 3. INITIALISATION & SECURITÉ
        auth.onAuthStateChanged(user => {
            if (user) {
                // Vérification du Bannissement en temps réel
                db.collection("users").doc(user.uid).onSnapshot(doc => {
                    if (doc.exists && doc.data().status === "Banni") {
                        alert("Session expirée.");
                        auth.signOut().then(() => window.location.href = "../login.html");
                    }
                });
            } else {
                window.location.href = "../login.html";
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Charger le Thème
            if(localStorage.getItem('payfusion-theme') === 'dark') {
                body.classList.add('dark-mode');
                themeToggle.checked = true;
            }

            // Charger la Langue
            const savedLang = localStorage.getItem('payfusion-lang') || 'fr';
            langSelect.value = savedLang;
            applyLanguage(savedLang);
        });

        async function saveLanguageToFirestore(lang) {
            const user = auth.currentUser;
            if(user) {
                await db.collection("users").doc(user.uid).update({ language: lang });
            }
        }

        function resetPassword() {
            const user = auth.currentUser;
            if(user) {
                auth.sendPasswordResetEmail(user.email).then(() => {
                    alert("Un lien de réinitialisation a été envoyé à : " + user.email);
                }).catch(err => alert("Erreur : " + err.message));
            }
        }

        function logout() {
            if(confirm("Voulez-vous vraiment vous déconnecter ?")) {
                auth.signOut().then(() => window.location.href = "../login.html");
            }
        }
    </script>
</body>
</html>